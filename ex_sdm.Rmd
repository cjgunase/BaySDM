---
title: "GRF vs MaxEnt"
author: "Chathura"
date: "November 29, 2016"
output: html_document
---


### Gaussian Random Fields

Using presense data about the species Xantusia Riversiana. 

```{r, echo=FALSE}
url <- "http://www.californiaherps.com/lizards/images/xriversiana104.jpg"
```
<img src="`r url`" height="200px" width="150px">

Only 50 presence locations were selected to emphasize the capabilites of GRF over MaxEnt. GRF have higher AUC when number of observations are low. If there are many observations MaxEnt has a better AUC.



### Plot the presence on map
```{r, message=FALSE, warning= FALSE}
# load package and data
require(maptools)
require(maps)
require(mapdata)
require(dismo)
require(GRaF)
library(pROC)
locs = read.csv(file="./Xantusia_riversiana.csv", header=T, sep=",")
locs <-locs[1:50,]
colnames(locs)<-c("ind","species","lat","lon")
plot(c(-119, -110), c(33.5, 38), mar=par("mar"), xlab="longitude", ylab="latitude", xaxt="n", yaxt="n", type="n", main="Xantusia Riversiana Presence")
rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4], col="lightblue")
map("state", xlim=c(-119, -110), ylim=c(33.5, 38), fill=T, col="cornsilk", add=T)

text(x=-117.5, y=35.5, "California", col="cornsilk3", cex=3)
text(x=-116, y=37.5, "Nevada", col="cornsilk3", cex=3)
text(x=-113, y=34.5, "Arizona", col="cornsilk3", cex=3)
text(x=-113, y=37.75, "Utah", col="cornsilk3", cex=3)

points(locs$lon, locs$lat, col="darkolivegreen4", pch=20, cex=0.5)

axis(1,las=1)
axis(2,las=1)
box()

```

### Correct for sampling bias
```{r,message=FALSE, warning= FALSE}
# create sequences of latitude and longitude values to define the grid
longrid = seq(-119, -110,0.05)
latgrid = seq(33.5, 38,0.05)

# identify points within each grid cell, draw one at random
subs = c()
for(i in 1:(length(longrid)-1)){
  for(j in 1:(length(latgrid)-1)){
    gridsq = subset(locs, lat > latgrid[j] & lat < latgrid[j+1] & lon > longrid[i] & lon < longrid[i+1])     
    if(dim(gridsq)[1]>0){
      subs = rbind(subs, gridsq[sample(1:dim(gridsq)[1],1 ), ])
    }
  }
}
dim(subs) # confirm that you have a smaller dataset than you started with

```

### Generate background data (psuedo-absent) using Raster package.
```{r,message=FALSE, warning= FALSE}
require(raster)

# define circles with a radius of 50 km around the subsampled points
x = circles(subs[,c("lon","lat")], d=50000, lonlat=T)
# draw random points that must fall within the circles in object x
bg = spsample(x@polygons, 100, type='random', iter=100)
BClim = getData("worldclim", var="bio", res=2.5, path="data/")
YbrevRange = extent(-119.25,-112.75,33.25,38.25) # define the extent
BClim = crop(BClim, YbrevRange)
writeRaster(BClim, filename="./data/YbrevBC_2.5.grd", overwrite=T)
BClim = brick("data/YbrevBC_2.5.grd")
# this format plots 1 (of 19) variables stored in BClim
plot(BClim, 1, cex=0.5, legend=T, mar=par("mar"), xaxt="n", yaxt="n", main="Annual mean temperature (ÂºC x 10)")
map("state", xlim=c(-119, -110), ylim=c(33.5, 38), fill=F, col="cornsilk", add=T)
# state names
text(x=-117.5, y=35.5, "California", col=rgb(1,1,1,0.4), cex=3)
text(x=-116, y=37.5, "Nevada", col=rgb(1,1,1,0.4), cex=3)
text(x=-113, y=34.5, "Arizona", col=rgb(1,1,1,0.4), cex=3)
text(x=-113, y=37.75, "Utah", col=rgb(1,1,1,0.4), cex=3)
# plot the presence points
points(locs$lon, locs$lat, pch=20, cex=0.5, col="darkgreen")
# and the pseudo-absence points
points(bg, cex=0.5, col="darkorange3")
# add axes
axis(1,las=1)
axis(2,las=1)
box()
```

```{r,message=FALSE, warning= FALSE}
# pulling bioclim values
Ybrev_bc = extract(BClim, subs[,c("lon","lat")]) # for the subsampled presence points
bg_bc = extract(BClim, bg) # for the pseudo-absence points
Ybrev_bc = data.frame(lon=subs$lon, lat=subs$lat, Ybrev_bc)
bgpoints = bg@coords
colnames(bgpoints) = c("lon","lat")
bg_bc = data.frame(cbind(bgpoints,bg_bc))
length(which(is.na(bg_bc$bio1))) # double-check for missing data
bg_bc = bg_bc[!is.na(bg_bc$bio1), ] # and pull out the missing lines


```


# Create dataframe from bioclim and presense/absance.
```{r,message=FALSE, warning= FALSE}
pres<-rep(1,dim(Ybrev_bc)[1])
temp1<-data.frame(pres,Ybrev_bc[,3:21])
pres<-rep(0,dim(bg_bc)[1])
temp2<-data.frame(pres,bg_bc[,3:21])
df<-rbind(temp1,temp2)
head(df,5)
tail(df,5)
```
### Prior knowldege about the temperature range for  Xantusia Riversiana
Tmax = 36 C
Tmin = 6.6 C

First build the GRF model without the prior.
```{r,message=FALSE, warning= FALSE}
#covs <- df[1:1037, c("pres","bio1", "bio12")]# Not sure these are the best variables.
covs <- df

## 75% of the sample size
smp_size <- floor(0.75 * nrow(covs))
set.seed(123)
train_ind <- sample(seq_len(nrow(covs)), size = smp_size)
train <- covs[train_ind, ]
test <- covs[-train_ind, ]

pa_tr <- train$pres
pa_te <- test$pres
m1 <- graf(pa_tr, train[,2:20])
pred_df<-data.frame(predict(m1,test[,2:20]))

print(paste("Area under ROC with No knowledge of thermal niche : ",auc(pa_te, pred_df$posterior.mode)))
#par(mfrow = c(4, 5))
#plot(m1, peak = TRUE)
#DIC(m1)
```

second, buid the GRF model with  thermal niche of the species  to increase the prediction accuracy of the distribution.

Intuitively, if some latent structure generalise the environmental variables of a location. We can expect another location with similar laten structure presents favorable conditions for a species to distribute. This notion can be captured in a GRF.

Since we know the species prefered temperature, we can adject the probability of presence based on the temperature of the location by defining a threshold function as below. This prototype only considers the naive thermal niche of the species.

* This mean function define the threshold function using the thermal niche of the species, this simply means there is higher probablity for the species to distribute when average temperure is between 15C - 35 C. The probability values were a naive guess to check the prototype works.

The mean function can take many forms, I just took it as a threshold for the prototype. 

```{r,message=FALSE, warning= FALSE}

thresh <- function(x) ifelse(x$bio1 < 150 | x$bio1 > 350 ,0.3, 0.6)

```

Now build the GRF with threshold function.
```{r,message=FALSE, warning= FALSE}
# fit the model, optimising the lengthscale
m3 <- graf(pa_tr, train[,2:20],opt.l = TRUE, prior = thresh)
pred_df<-data.frame(predict(m3,test[,2:20]))
print(paste("Area under ROC with prior knowledge of thermal niche : ",auc(pa_te, pred_df$posterior.mode)))
#plot(m3, prior = TRUE, main = "With threshold prior")

```

Interfacing to Raster map from the GRF needs more work. The threshold function can be made more complex as needed to consider multiple variable conditions.

This GRF based method is very recently published here. 
http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12523/epdf

I think this framework can be further improved and a perfect research direction to improve correlative SDMs with prior mechnistic knowledge. 



MaxEnt
--------
The MaxEnt does not consider the prior knowledge. So if less number of observations results in less predition accuracy. GRF has the ability to incorporate prior knowledge as demonstraded above.

```{r,message=FALSE, warning= FALSE}
group_p = kfold(Ybrev_bc, 5) # vector of group assignments splitting the Ybrev_bc into 5 groups
group_a = kfold(bg_bc, 5) # ditto for bg_bc

test = 3

train_p = Ybrev_bc[group_p!=test, c("lon","lat")]
train_a = bg_bc[group_a!=test, c("lon","lat")]
test_p = Ybrev_bc[group_p==test, c("lon","lat")]
test_a = bg_bc[group_a==test, c("lon","lat")]

me = maxent(BClim, p=train_p, a=train_a)
e = evaluate(test_p, test_a, me, BClim)
e


```

Prediction map for MaxEnt.
```{r,message=FALSE, warning= FALSE}

pred_me = predict(me, BClim) # generate the predictions
# make a nice plot
plot(pred_me, 1, cex=0.5, legend=T, mar=par("mar"), xaxt="n", yaxt="n", main="Predicted presence of the species")
map("state", xlim=c(-119, -110), ylim=c(33.5, 38), fill=F, col="cornsilk", add=T)

# state names
text(x=-117.5, y=35.5, "California", col=rgb(1,1,1,0.6), cex=3)
text(x=-116, y=37.5, "Nevada", col=rgb(1,1,1,0.6), cex=3)
text(x=-113, y=34.5, "Arizona", col=rgb(1,1,1,0.6), cex=3)
text(x=-113, y=37.75, "Utah", col=rgb(1,1,1,0.6), cex=3)

# presence points
points(locs$lon, locs$lat, pch=20, cex=0.5, col="darkgreen")
# pseud-absence points
points(bg, cex=0.5, col="darkorange3")

# add axes
axis(1,las=1)
axis(2,las=1)

# restore the box around the map
box()
```

